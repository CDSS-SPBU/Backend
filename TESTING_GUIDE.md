# Руководство по тестированию системы поддержки принятия врачебных решений

## Описание системы

Система поддержки принятия врачебных решений на основе клинических рекомендаций. Предоставляет второе мнение для врача на основании клинических рекомендаций (https://cr.minzdrav.gov.ru/clin-rec) в виде вопрос-ответной системы.

## Архитектура системы

Система состоит из трех сервисов:
1. **embedding-service** (порт 8000) - генерация эмбеддингов и сохранение клинических рекомендаций в БД
2. **rerank-service** (порт 8001) - переранжирование фрагментов рекомендаций по релевантности запросу врача
3. **postgres** (порт 5433) - база данных с векторными индексами клинических рекомендаций

---

## 1. Проверка здоровья сервисов

### Embedding Service
```bash
curl http://localhost:8000/health
```

**Ожидаемый ответ:**
```json
{
  "status": "healthy",
  "model_loaded": true,
  "db_connected": true
}
```

### Rerank Service
```bash
curl http://localhost:8001/health
```

**Ожидаемый ответ:**
```json
{
  "status": "healthy",
  "model_loaded": true
}
```

---

## 2. Тестирование Embedding Service

### 2.1. Сохранение клинических рекомендаций в БД (task: retrieval.passage)

**Эндпоинт:** `POST http://localhost:8000/embed`

**Важно:** Каждый фрагмент рекомендации должен содержать метаданные с точной ссылкой на источник (название документа, номер рекомендации, раздел, страница).

**Входные данные:**
```json
{
  "texts": [
    "При острой боли в поясничной области, связанной с защемлением позвоночного нерва, рекомендуется назначение нестероидных противовоспалительных препаратов (НПВП) в течение 5-7 дней. Препараты выбора: диклофенак 75-150 мг/сут, ибупрофен 1200-2400 мг/сут, кетопрофен 100-200 мг/сут. При отсутствии эффекта в течение 3 дней рассмотреть возможность назначения миорелаксантов.",
    "При неосложненной артериальной гипертензии первой степени (АД 140-159/90-99 мм рт.ст.) у пациентов без факторов риска рекомендуется немедикаментозная терапия: ограничение соли до 5 г/сут, снижение массы тела при избыточном весе, регулярная физическая активность, отказ от курения. При отсутствии эффекта через 3-6 месяцев назначать ингибиторы АПФ или блокаторы рецепторов ангиотензина II.",
    "При остром гастрите с болевым синдромом рекомендуется назначение ингибиторов протонной помпы (омепразол 20 мг 2 раза в день, пантопразол 40 мг 1 раз в день) в течение 7-14 дней. При наличии Helicobacter pylori показана эрадикационная терапия по схеме: ингибитор протонной помпы + амоксициллин 1000 мг 2 раза в день + кларитромицин 500 мг 2 раза в день в течение 14 дней."
  ],
  "metadata": [
    {
      "document_name": "Клинические рекомендации по лечению болей в спине",
      "document_id": "KR-001",
      "section": "Острая боль в поясничной области",
      "page": 15,
      "recommendation_number": "3.2.1",
      "source_url": "https://cr.minzdrav.gov.ru/clin-rec/KR-001"
    },
    {
      "document_name": "Клинические рекомендации по артериальной гипертензии",
      "document_id": "KR-002",
      "section": "Лечение АГ первой степени",
      "page": 8,
      "recommendation_number": "2.1.3",
      "source_url": "https://cr.minzdrav.gov.ru/clin-rec/KR-002"
    },
    {
      "document_name": "Клинические рекомендации по гастриту",
      "document_id": "KR-003",
      "section": "Острый гастрит",
      "page": 12,
      "recommendation_number": "4.1.2",
      "source_url": "https://cr.minzdrav.gov.ru/clin-rec/KR-003"
    }
  ],
  "task": "retrieval.passage",
  "dimensions": 1024
}
```

**Ожидаемый ответ:**
```json
{
  "inserted_ids": [1, 2, 3],
  "count": 3,
  "batch_size": 3,
  "embedding_dimensions": 1024
}
```

**cURL команда:**
```bash
curl -X POST http://localhost:8000/embed \
  -H "Content-Type: application/json" \
  -d '{
    "texts": [
      "При острой боли в поясничной области, связанной с защемлением позвоночного нерва, рекомендуется назначение нестероидных противовоспалительных препаратов (НПВП) в течение 5-7 дней.",
      "При неосложненной артериальной гипертензии первой степени рекомендуется немедикаментозная терапия: ограничение соли до 5 г/сут, снижение массы тела, регулярная физическая активность.",
      "При остром гастрите с болевым синдромом рекомендуется назначение ингибиторов протонной помпы в течение 7-14 дней."
    ],
    "metadata": [
      {
        "document_name": "Клинические рекомендации по лечению болей в спине",
        "document_id": "KR-001",
        "section": "Острая боль в поясничной области",
        "page": 15,
        "recommendation_number": "3.2.1"
      },
      {
        "document_name": "Клинические рекомендации по артериальной гипертензии",
        "document_id": "KR-002",
        "section": "Лечение АГ первой степени",
        "page": 8,
        "recommendation_number": "2.1.3"
      },
      {
        "document_name": "Клинические рекомендации по гастриту",
        "document_id": "KR-003",
        "section": "Острый гастрит",
        "page": 12,
        "recommendation_number": "4.1.2"
      }
    ],
    "task": "retrieval.passage",
    "dimensions": 1024
  }'
```

### 2.2. Генерация эмбеддинга для запроса врача (task: retrieval.query)

**Эндпоинт:** `POST http://localhost:8000/embed`

**Входные данные:**
```json
{
  "texts": ["Чем лучше лечить пациента с защемлением позвоночного нерва?"],
  "task": "retrieval.query",
  "dimensions": 1024
}
```

**Ожидаемый ответ:**
```json
{
  "embedding": [[0.0123, -0.0456, 0.0789, ...]],  // массив из 1024 чисел
  "count": 1,
  "batch_size": 1,
  "embedding_dimensions": 1024,
  "status": "success"
}
```

**cURL команда:**
```bash
curl -X POST http://localhost:8000/embed \
  -H "Content-Type: application/json" \
  -d '{
    "texts": ["Чем лучше лечить пациента с защемлением позвоночного нерва?"],
    "task": "retrieval.query",
    "dimensions": 1024
  }'
```

### Ограничения Embedding Service:
- Максимальный размер батча: **12 текстов**
- Максимальная длина текста: **10,000 символов**
- Доступные размерности: **64, 128, 256, 384, 512, 768, 1024** (по умолчанию 1024)
- Типы задач: `retrieval.passage` или `retrieval.query`

---

## 3. Тестирование Rerank Service

### Переранжирование фрагментов рекомендаций по релевантности запросу

**Эндпоинт:** `POST http://localhost:8001/rerank`

**Входные данные:**
```json
{
  "query": "Чем лучше лечить пациента с защемлением позвоночного нерва?",
  "passages": [
    "При острой боли в поясничной области, связанной с защемлением позвоночного нерва, рекомендуется назначение нестероидных противовоспалительных препаратов (НПВП) в течение 5-7 дней. Препараты выбора: диклофенак 75-150 мг/сут, ибупрофен 1200-2400 мг/сут.",
    "При хронической боли в спине рекомендуется комплексная терапия, включающая физиотерапию, лечебную физкультуру и при необходимости антидепрессанты.",
    "При неосложненной артериальной гипертензии рекомендуется немедикаментозная терапия: ограничение соли до 5 г/сут, снижение массы тела.",
    "При защемлении нерва в шейном отделе позвоночника показаны НПВП, миорелаксанты и ношение воротника Шанца в течение 2-3 недель."
  ],
  "metadata": [
    {
      "document_name": "Клинические рекомендации по лечению болей в спине",
      "document_id": "KR-001",
      "recommendation_number": "3.2.1"
    },
    {
      "document_name": "Клинические рекомендации по лечению болей в спине",
      "document_id": "KR-001",
      "recommendation_number": "3.3.2"
    },
    {
      "document_name": "Клинические рекомендации по артериальной гипертензии",
      "document_id": "KR-002",
      "recommendation_number": "2.1.3"
    },
    {
      "document_name": "Клинические рекомендации по лечению болей в спине",
      "document_id": "KR-001",
      "recommendation_number": "3.1.4"
    }
  ]
}
```

**Ожидаемый ответ:**
```json
{
  "reranked_results": [
    {
      "text": "При острой боли в поясничной области, связанной с защемлением позвоночного нерва, рекомендуется назначение нестероидных противовоспалительных препаратов (НПВП) в течение 5-7 дней. Препараты выбора: диклофенак 75-150 мг/сут, ибупрофен 1200-2400 мг/сут.",
      "score": 0.95,
      "rank": 1
    },
    {
      "text": "При защемлении нерва в шейном отделе позвоночника показаны НПВП, миорелаксанты и ношение воротника Шанца в течение 2-3 недель.",
      "score": 0.82,
      "rank": 2
    },
    {
      "text": "При хронической боли в спине рекомендуется комплексная терапия, включающая физиотерапию, лечебную физкультуру и при необходимости антидепрессанты.",
      "score": 0.65,
      "rank": 3
    },
    {
      "text": "При неосложненной артериальной гипертензии рекомендуется немедикаментозная терапия: ограничение соли до 5 г/сут, снижение массы тела.",
      "score": 0.35,
      "rank": 4
    }
  ],
  "original_query": "Чем лучше лечить пациента с защемлением позвоночного нерва?"
}
```

**cURL команда:**
```bash
curl -X POST http://localhost:8001/rerank \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Чем лучше лечить пациента с защемлением позвоночного нерва?",
    "passages": [
      "При острой боли в поясничной области, связанной с защемлением позвоночного нерва, рекомендуется назначение нестероидных противовоспалительных препаратов (НПВП) в течение 5-7 дней.",
      "При хронической боли в спине рекомендуется комплексная терапия, включающая физиотерапию и лечебную физкультуру.",
      "При неосложненной артериальной гипертензии рекомендуется немедикаментозная терапия.",
      "При защемлении нерва в шейном отделе позвоночника показаны НПВП и миорелаксанты."
    ]
  }'
```

### Ограничения Rerank Service:
- Максимальная длина запроса: **500 символов**
- Максимальное количество текстов: **20**
- Максимальное количество токенов (query + passage): **512** (примерно 256 символов на пару)

---

## 4. Полный сценарий тестирования (End-to-End)

### Шаг 1: Загрузить клинические рекомендации в БД

```bash
curl -X POST http://localhost:8000/embed \
  -H "Content-Type: application/json" \
  -d '{
    "texts": [
      "При острой боли в поясничной области, связанной с защемлением позвоночного нерва, рекомендуется назначение нестероидных противовоспалительных препаратов (НПВП) в течение 5-7 дней. Препараты выбора: диклофенак 75-150 мг/сут, ибупрофен 1200-2400 мг/сут, кетопрофен 100-200 мг/сут. При отсутствии эффекта в течение 3 дней рассмотреть возможность назначения миорелаксантов.",
      "При неосложненной артериальной гипертензии первой степени (АД 140-159/90-99 мм рт.ст.) у пациентов без факторов риска рекомендуется немедикаментозная терапия: ограничение соли до 5 г/сут, снижение массы тела при избыточном весе, регулярная физическая активность, отказ от курения.",
      "При остром гастрите с болевым синдромом рекомендуется назначение ингибиторов протонной помпы (омепразол 20 мг 2 раза в день, пантопразол 40 мг 1 раз в день) в течение 7-14 дней.",
      "При остром бронхите вирусной этиологии антибактериальная терапия не показана. Рекомендуется симптоматическое лечение: обильное питье, жаропонижающие препараты при температуре выше 38.5°C, противокашлевые средства при сухом кашле.",
      "При пневмонии внебольничной у пациентов без факторов риска рекомендуется назначение амоксициллина 1000 мг 3 раза в день или амоксициллина/клавуланата 625 мг 3 раза в день в течение 7-10 дней."
    ],
    "metadata": [
      {
        "document_name": "Клинические рекомендации по лечению болей в спине",
        "document_id": "KR-001",
        "section": "Острая боль в поясничной области",
        "page": 15,
        "recommendation_number": "3.2.1",
        "source_url": "https://cr.minzdrav.gov.ru/clin-rec/KR-001"
      },
      {
        "document_name": "Клинические рекомендации по артериальной гипертензии",
        "document_id": "KR-002",
        "section": "Лечение АГ первой степени",
        "page": 8,
        "recommendation_number": "2.1.3",
        "source_url": "https://cr.minzdrav.gov.ru/clin-rec/KR-002"
      },
      {
        "document_name": "Клинические рекомендации по гастриту",
        "document_id": "KR-003",
        "section": "Острый гастрит",
        "page": 12,
        "recommendation_number": "4.1.2",
        "source_url": "https://cr.minzdrav.gov.ru/clin-rec/KR-003"
      },
      {
        "document_name": "Клинические рекомендации по острому бронхиту",
        "document_id": "KR-004",
        "section": "Лечение острого бронхита",
        "page": 6,
        "recommendation_number": "2.3.1",
        "source_url": "https://cr.minzdrav.gov.ru/clin-rec/KR-004"
      },
      {
        "document_name": "Клинические рекомендации по внебольничной пневмонии",
        "document_id": "KR-005",
        "section": "Антибактериальная терапия",
        "page": 22,
        "recommendation_number": "5.1.1",
        "source_url": "https://cr.minzdrav.gov.ru/clin-rec/KR-005"
      }
    ],
    "task": "retrieval.passage",
    "dimensions": 1024
  }'
```

### Шаг 2: Создать эмбеддинг для запроса врача

```bash
curl -X POST http://localhost:8000/embed \
  -H "Content-Type: application/json" \
  -d '{
    "texts": ["Чем лучше лечить пациента с защемлением позвоночного нерва?"],
    "task": "retrieval.query",
    "dimensions": 1024
  }'
```

### Шаг 3: Найти релевантные рекомендации в БД (через SQL)

```sql
-- Подключитесь к БД: psql -h localhost -p 5433 -U embedd_user -d rag
-- Пароль: embedd_password

-- Используйте эмбеддинг из шага 2 (замените [...] на реальный массив)
SELECT 
  id, 
  content, 
  metadata->>'document_name' as document_name,
  metadata->>'recommendation_number' as recommendation_number,
  metadata->>'source_url' as source_url,
  1 - (embedding <=> '[0.0123, -0.0456, ...]'::vector) as similarity
FROM chunks
ORDER BY embedding <=> '[0.0123, -0.0456, ...]'::vector
LIMIT 5;
```

### Шаг 4: Переранжировать найденные результаты

```bash
curl -X POST http://localhost:8001/rerank \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Чем лучше лечить пациента с защемлением позвоночного нерва?",
    "passages": [
      "При острой боли в поясничной области, связанной с защемлением позвоночного нерва, рекомендуется назначение нестероидных противовоспалительных препаратов (НПВП)...",
      "При хронической боли в спине рекомендуется комплексная терапия...",
      "При неосложненной артериальной гипертензии рекомендуется немедикаментозная терапия..."
    ]
  }'
```

---

## 5. Тестирование обработки ошибок и граничных случаев

### 5.1. Превышение размера батча

```bash
curl -X POST http://localhost:8000/embed \
  -H "Content-Type: application/json" \
  -d '{
    "texts": ["text1", "text2", "text3", "text4", "text5", "text6", "text7", "text8", "text9", "text10", "text11", "text12", "text13"],
    "task": "retrieval.passage"
  }'
```

**Ожидаемый ответ:** `422 Unprocessable Entity` с описанием ошибки

### 5.2. Пустой текст

```bash
curl -X POST http://localhost:8000/embed \
  -H "Content-Type: application/json" \
  -d '{
    "texts": [""],
    "task": "retrieval.passage"
  }'
```

**Ожидаемый ответ:** `422 Unprocessable Entity`

### 5.3. Превышение количества текстов в rerank

```bash
curl -X POST http://localhost:8001/rerank \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Как лечить?",
    "passages": ["text1", "text2", "text3", "text4", "text5", "text6", "text7", "text8", "text9", "text10", "text11", "text12", "text13", "text14", "text15", "text16", "text17", "text18", "text19", "text20", "text21"]
  }'
```

**Ожидаемый ответ:** `422 Unprocessable Entity`

### 5.4. Тест ложноположительных рассуждений (важно для медицинской системы)

**Сценарий 1: Несуществующее заболевание**

```bash
curl -X POST http://localhost:8001/rerank \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Как лечить блинную сыпь?",
    "passages": [
      "При острой боли в поясничной области рекомендуется назначение НПВП.",
      "При аллергической сыпи показаны антигистаминные препараты.",
      "При псориазе применяются топические кортикостероиды."
    ]
  }'
```

**Ожидаемое поведение:** Система должна вернуть низкие скоры для всех результатов, и приложение должно обработать это как отсутствие релевантных данных, ответив: "Данных о таком заболевании нет в моей базе данных."

**Сценарий 2: Несуществующий вариант известного заболевания**

```bash
curl -X POST http://localhost:8001/rerank \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Как лечить гепатит Ж?",
    "passages": [
      "При гепатите А показана симптоматическая терапия и диета.",
      "При гепатите В назначается противовирусная терапия.",
      "При гепатите С применяются препараты прямого противовирусного действия."
    ]
  }'
```

**Ожидаемое поведение:** Система должна ответить: "Данных о таком заболевании нет в моей базе данных. Существуют такие гепатиты: гепатит А, гепатит В, гепатит С..."

**Сценарий 3: Невозможное клиническое состояние**

```bash
curl -X POST http://localhost:8001/rerank \
  -H "Content-Type: application/json" \
  -d '{
    "query": "Ко мне пришел пациент с температурой 400 градусов",
    "passages": [
      "При лихорадке выше 38.5°C показаны жаропонижающие препараты.",
      "При гипертермии выше 40°C требуется неотложная медицинская помощь."
    ]
  }'
```

**Ожидаемое поведение:** Система должна ответить: "У меня нет данных по таким состояниям человека."

---

## 6. Полезные команды для отладки

### Просмотр логов сервисов
```bash
# Логи embedding-service
docker logs embedding_api -f

# Логи rerank-service
docker logs rerank_api -f

# Логи postgres
docker logs vector_pg -f
```

### Подключение к БД
```bash
docker exec -it vector_pg psql -U embedd_user -d rag
```

### Просмотр сохраненных рекомендаций
```sql
SELECT 
  id, 
  content, 
  metadata->>'document_name' as document_name,
  metadata->>'recommendation_number' as recommendation_number,
  metadata->>'source_url' as source_url
FROM chunks
LIMIT 10;
```

### Поиск рекомендаций по документу
```sql
SELECT 
  id,
  content,
  metadata->>'recommendation_number' as recommendation_number
FROM chunks
WHERE metadata->>'document_id' = 'KR-001'
ORDER BY metadata->>'recommendation_number';
```

### Проверка количества записей
```sql
SELECT COUNT(*) FROM chunks;
```

### Проверка уникальных документов
```sql
SELECT DISTINCT metadata->>'document_id', metadata->>'document_name'
FROM chunks;
```

---

## 7. Примеры клинических рекомендаций для тестирования

### Кардиология
```json
{
  "texts": [
    "При остром инфаркте миокарда с подъемом сегмента ST показана экстренная реперфузионная терапия: чрескожное коронарное вмешательство в течение 90 минут от первого медицинского контакта или тромболитическая терапия при невозможности выполнения ЧКВ в течение 30 минут. Дополнительно назначается ацетилсалициловая кислота 300 мг (разжевать), клопидогрел 600 мг, аторвастатин 80 мг."
  ],
  "metadata": [
    {
      "document_name": "Клинические рекомендации по острому коронарному синдрому",
      "document_id": "KR-006",
      "section": "Острый инфаркт миокарда с подъемом ST",
      "page": 45,
      "recommendation_number": "6.2.1",
      "source_url": "https://cr.minzdrav.gov.ru/clin-rec/KR-006"
    }
  ]
}
```

### Неврология
```json
{
  "texts": [
    "При ишемическом инсульте в первые 4.5 часа от начала симптомов показана тромболитическая терапия алтеплазой 0.9 мг/кг (максимум 90 мг). Противопоказания: геморрагический инсульт в анамнезе, тяжелая черепно-мозговая травма, активное кровотечение, артериальное давление выше 185/110 мм рт.ст."
  ],
  "metadata": [
    {
      "document_name": "Клинические рекомендации по острому ишемическому инсульту",
      "document_id": "KR-007",
      "section": "Тромболитическая терапия",
      "page": 18,
      "recommendation_number": "4.1.1",
      "source_url": "https://cr.minzdrav.gov.ru/clin-rec/KR-007"
    }
  ]
}
```

### Гастроэнтерология
```json
{
  "texts": [
    "При язвенной болезни желудка и двенадцатиперстной кишки, ассоциированной с Helicobacter pylori, показана эрадикационная терапия первой линии: ингибитор протонной помпы (омепразол 20 мг 2 раза в день или пантопразол 40 мг 2 раза в день) + амоксициллин 1000 мг 2 раза в день + кларитромицин 500 мг 2 раза в день в течение 14 дней. При аллергии на пенициллин используется схема с метронидазолом 500 мг 2 раза в день вместо амоксициллина."
  ],
  "metadata": [
    {
      "document_name": "Клинические рекомендации по язвенной болезни",
      "document_id": "KR-008",
      "section": "Эрадикация H. pylori",
      "page": 25,
      "recommendation_number": "5.2.1",
      "source_url": "https://cr.minzdrav.gov.ru/clin-rec/KR-008"
    }
  ]
}
```

### Пульмонология
```json
{
  "texts": [
    "При бронхиальной астме легкой степени тяжести рекомендуется базисная терапия ингаляционными глюкокортикостероидами в низких дозах (беклометазон 200-400 мкг/сут или будесонид 200-400 мкг/сут) или антагонистами лейкотриеновых рецепторов (монтелукаст 10 мг 1 раз в день). При недостаточном контроле добавляется длительнодействующий бета-2-агонист."
  ],
  "metadata": [
    {
      "document_name": "Клинические рекомендации по бронхиальной астме",
      "document_id": "KR-009",
      "section": "Базисная терапия БА",
      "page": 32,
      "recommendation_number": "7.1.2",
      "source_url": "https://cr.minzdrav.gov.ru/clin-rec/KR-009"
    }
  ]
}
```

---

## 8. Проверка целостности данных (важно для медицинской системы)

### Проверка наличия метаданных у всех записей
```sql
SELECT COUNT(*) as total,
       COUNT(metadata->>'document_name') as with_document_name,
       COUNT(metadata->>'document_id') as with_document_id,
       COUNT(metadata->>'recommendation_number') as with_recommendation_number,
       COUNT(metadata->>'source_url') as with_source_url
FROM chunks;
```

### Поиск записей без обязательных метаданных
```sql
SELECT id, content, metadata
FROM chunks
WHERE metadata->>'document_name' IS NULL 
   OR metadata->>'document_id' IS NULL
   OR metadata->>'recommendation_number' IS NULL;
```

### Проверка уникальности рекомендаций
```sql
SELECT 
  metadata->>'document_id' as document_id,
  metadata->>'recommendation_number' as recommendation_number,
  COUNT(*) as count
FROM chunks
GROUP BY metadata->>'document_id', metadata->>'recommendation_number'
HAVING COUNT(*) > 1;
```

---

## 9. Сценарии для администратора системы

### Удаление документа из базы

```sql
-- Удалить все рекомендации конкретного документа
DELETE FROM chunks 
WHERE metadata->>'document_id' = 'KR-001';

-- Проверить удаление
SELECT COUNT(*) 
FROM chunks 
WHERE metadata->>'document_id' = 'KR-001';
```

### Добавление нового документа

```bash
curl -X POST http://localhost:8000/embed \
  -H "Content-Type: application/json" \
  -d '{
    "texts": [
      "Новая рекомендация по лечению..."
    ],
    "metadata": [
      {
        "document_name": "Новые клинические рекомендации",
        "document_id": "KR-010",
        "section": "Раздел",
        "page": 1,
        "recommendation_number": "1.1.1",
        "source_url": "https://cr.minzdrav.gov.ru/clin-rec/KR-010"
      }
    ],
    "task": "retrieval.passage",
    "dimensions": 1024
  }'
```

### Проверка работы системы после изменений

После удаления или добавления документа необходимо проверить, что система корректно работает:

1. Выполнить поиск по удаленному документу - должен вернуть пустой результат
2. Выполнить поиск по новому документу - должен вернуть новые рекомендации
3. Проверить, что метаданные корректно сохраняются и отображаются

---

## 10. Важные требования для медицинской системы

### 10.1. Обязательное указание источника

**Критично:** Каждая рекомендация должна содержать:
- `document_name` - полное название документа
- `document_id` - уникальный идентификатор документа
- `recommendation_number` - номер рекомендации
- `source_url` - ссылка на источник (если доступна)
- `section` - раздел документа
- `page` - страница в документе

### 10.2. Запрет на галлюцинации

Система НЕ должна:
- Выдавать рекомендации без указания источника
- Искажать текст рекомендаций
- Искажать названия документов
- Связывать текст с неправильным источником
- Выдавать рекомендации, которых нет в базе данных

### 10.3. Обработка отсутствия данных

При отсутствии релевантных данных система должна:
- Четко сообщать об отсутствии данных
- Не пытаться "угадать" ответ
- Предлагать альтернативные варианты, если они есть (например, "Существуют такие гепатиты...")

---

## Примечания

1. **Время первого запроса** может быть больше из-за загрузки моделей в память
2. **Размерность эмбеддингов** должна быть одинаковой для всех запросов (рекомендуется 1024)
3. **Метаданные обязательны** для медицинской системы - без них рекомендация не может быть использована
4. **Батчинг** значительно ускоряет обработку — используйте максимальный размер батча (12) когда возможно
5. **Проверка целостности** - регулярно проверяйте наличие метаданных у всех записей
6. **Версионирование** - при обновлении рекомендаций рекомендуется сохранять старые версии с пометкой в метаданных
